{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">Crop Recommendation</h3>
            </div>
            <div class="card-body">
                <p class="lead">Provide your soil and climate details to get the best crop suggestions for your farm.</p>
                
                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                
                {% if form.errors %}
                <div class="alert alert-danger">
                    <h5>Please fix the following errors:</h5>
                    <ul class="mb-0">
                        {% for field_name, field_errors in form.errors|dictsort if field_errors %}
                            {% for error in field_errors %}
                                <li>{{ form[field_name].label }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('crop_recommendation') }}" class="needs-validation" novalidate enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    
                    <h5 class="mt-4 text-success">Location Details</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.state.label(class="form-label") }}
                                {{ form.state(class="form-select" + (' is-invalid' if form.state.errors else '')) }}
                                {% if form.state.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.state.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.district.label(class="form-label") }}
                                {{ form.district(class="form-control" + (' is-invalid' if form.district.errors else '')) }}
                                {% if form.district.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.district.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mt-4 text-success">Soil Properties</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.soil_type.label(class="form-label") }}
                                {{ form.soil_type(class="form-select" + (' is-invalid' if form.soil_type.errors else '')) }}
                                {% if form.soil_type.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.soil_type.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.ph_level.label(class="form-label") }}
                                {{ form.ph_level(class="form-control" + (' is-invalid' if form.ph_level.errors else '')) }}
                                <div class="form-text">Ideal range: 5.5 - 7.5 for most crops</div>
                                {% if form.ph_level.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.ph_level.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mt-4 text-success">Nutrient Levels (kg/ha)</h5>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ form.nitrogen.label(class="form-label") }}
                                {{ form.nitrogen(class="form-control" + (' is-invalid' if form.nitrogen.errors else '')) }}
                                {% if form.nitrogen.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.nitrogen.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ form.phosphorus.label(class="form-label") }}
                                {{ form.phosphorus(class="form-control" + (' is-invalid' if form.phosphorus.errors else '')) }}
                                {% if form.phosphorus.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.phosphorus.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ form.potassium.label(class="form-label") }}
                                {{ form.potassium(class="form-control" + (' is-invalid' if form.potassium.errors else '')) }}
                                {% if form.potassium.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.potassium.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mt-4 text-success">Climate Conditions</h5>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ form.rainfall.label(class="form-label") }}
                                {{ form.rainfall(class="form-control" + (' is-invalid' if form.rainfall.errors else '')) }}
                                <div class="form-text">Average annual rainfall in your area</div>
                                {% if form.rainfall.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.rainfall.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ form.temperature.label(class="form-label") }}
                                {{ form.temperature(class="form-control" + (' is-invalid' if form.temperature.errors else '')) }}
                                <div class="form-text">Average annual temperature</div>
                                {% if form.temperature.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.temperature.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ form.humidity.label(class="form-label") }}
                                {{ form.humidity(class="form-control" + (' is-invalid' if form.humidity.errors else '')) }}
                                <div class="form-text">Average relative humidity</div>
                                {% if form.humidity.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.humidity.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ form.irrigation.label(class="form-label") }}
                                {{ form.irrigation(class="form-select" + (' is-invalid' if form.irrigation.errors else '')) }}
                                <div class="form-text">Select if irrigation is available</div>
                                {% if form.irrigation.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.irrigation.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">Get Recommendations</button>
                    </div>
                </form>
                
                {% if result %}
                <div class="mt-4">
                    <h4 class="text-success">Recommended Crops for Your Farm</h4>
                    <div class="row mt-4">
                        {% for crop in recommendations %}
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">{{ crop.name }}</h5>
                                </div>
                                <div class="card-body">
                                    <h6>Growing Conditions:</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="bi bi-droplet"></i> Soil: {{ crop.soil }}</li>
                                        <li><i class="bi bi-thermometer-half"></i> Temperature: {{ crop.temperature }}</li>
                                        <li><i class="bi bi-cloud-rain"></i> Rainfall: {{ crop.rainfall }}</li>
                                        <li><i class="bi bi-droplet-half"></i> pH Range: {{ crop.ph_range }}</li>
                                    </ul>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <button class="btn btn-outline-success btn-sm view-details" data-crop="{{ crop.name }}">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="mt-4">
                    <h5 class="text-success">Soil Analysis</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h6>Nutrient Levels</h6>
                                    <div class="progress mb-2 nutrient-progress">
                                        <div class="progress-bar bg-success" 
                                             role="progressbar" 
                                             style="width: {{ soil_analysis.nitrogen|default(0, true) }}%"
                                             aria-valuenow="{{ soil_analysis.nitrogen|default(0, true) }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            N: {{ soil_analysis.nitrogen|default(0) }}%
                                        </div>
                                    </div>
                                    <div class="progress mb-2 nutrient-progress">
                                        <div class="progress-bar bg-info" 
                                             role="progressbar" 
                                             style="width: {{ soil_analysis.phosphorus|default(0, true) }}%"
                                             aria-valuenow="{{ soil_analysis.phosphorus|default(0, true) }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            P: {{ soil_analysis.phosphorus|default(0) }}%
                                        </div>
                                    </div>
                                    <div class="progress mb-2 nutrient-progress">
                                        <div class="progress-bar bg-warning" 
                                             role="progressbar" 
                                             style="width: {{ soil_analysis.potassium|default(0, true) }}%"
                                             aria-valuenow="{{ soil_analysis.potassium|default(0, true) }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            K: {{ soil_analysis.potassium|default(0) }}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h6>Soil pH</h6>
                                    <div class="progress ph-progress">
                                        {% set ph = soil_analysis.ph|default(7, true) %}
                                        {% set ph_class = 'bg-danger' if ph < 5.5 or ph > 7.5 else 'bg-success' %}
                                        <div class="progress-bar {{ ph_class }}" 
                                             role="progressbar" 
                                             style="width: {{ (ph / 14) * 100 }}%"
                                             aria-valuenow="{{ ph }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="14">
                                            {{ "%.1f"|format(ph) }}
                                        </div>
                                    </div>
                                    <div class="mt-2 text-muted">
                                        <small>0 &nbsp;&nbsp;&nbsp;&nbsp; 7 (Neutral) &nbsp;&nbsp;&nbsp;&nbsp; 14</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Crop Details Modal -->
<div class="modal fade" id="cropDetailsModal" tabindex="-1" aria-labelledby="cropDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="cropDetailsModalLabel">Crop Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="cropDetailsContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
    .nutrient-progress {
        height: 24px;
    }
    .ph-progress {
        height: 30px;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
// Enable form validation
(function () {
    'use strict'
    
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.querySelectorAll('.needs-validation')
    
    // Loop over them and prevent submission
    Array.prototype.slice.call(forms)
        .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                
                form.classList.add('was-validated')
            }, false)
        })
})()

// Handle view details button click
document.querySelectorAll('.view-details').forEach(button => {
    button.addEventListener('click', function() {
        const cropName = this.getAttribute('data-crop');
        const modal = new bootstrap.Modal(document.getElementById('cropDetailsModal'));
        const modalTitle = document.getElementById('cropDetailsModalLabel');
        const modalContent = document.getElementById('cropDetailsContent');
        
        // Set modal title
        modalTitle.textContent = cropName + ' Details';
        
        // Load crop details (you can replace this with actual data)
        modalContent.innerHTML = `
            <h5>Growing Information</h5>
            <p>Detailed information about growing ${cropName} will be displayed here.</p>
            <div class="alert alert-info">
                <strong>Note:</strong> This is a placeholder. In a real application, 
                this would show detailed crop information from a database.
            </div>
        `;
        
        // Show the modal
        modal.show();
    });
});

// Dynamic district loading based on state (placeholder - in a real app, this would be an API call)
document.getElementById('state')?.addEventListener('change', function() {
    const state = this.value;
    const districtInput = document.getElementById('district');
    
    // In a real application, you would fetch districts for the selected state from an API
    // For now, we'll just clear the district field
    if (state && districtInput) {
        districtInput.value = '';
        districtInput.placeholder = 'Enter your district';
    }
});
</script>
{% endblock %}
