{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">Disaster Risk Prediction</h3>
            </div>
            <div class="card-body">
                <p class="lead">Assess potential risks to your farm and receive preventive recommendations.</p>
                
                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('disaster') }}" class="needs-validation" novalidate>
                    {{ form.hidden_tag() }}
                    
                    <h5 class="mt-4 text-success">Farm Location</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="state" class="form-label">State *</label>
                                <select class="form-select" id="state" name="state" required>
                                    <option value="" disabled selected>Select State</option>
                                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                                    <option value="Karnataka">Karnataka</option>
                                    <option value="Kerala">Kerala</option>
                                    <option value="Tamil Nadu">Tamil Nadu</option>
                                    <option value="Maharashtra">Maharashtra</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="district" class="form-label">District *</label>
                                <input type="text" class="form-control" id="district" name="district" required
                                       value="{{ request.form.district if request.form.district }}">
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mt-4 text-success">Crop Information</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="crop_type" class="form-label">Crop Type *</label>
                                <select class="form-select" id="crop_type" name="crop_type" required>
                                    <option value="" disabled selected>Select Crop</option>
                                    <option value="rice">Rice</option>
                                    <option value="wheat">Wheat</option>
                                    <option value="maize">Maize</option>
                                    <option value="sugarcane">Sugarcane</option>
                                    <option value="cotton">Cotton</option>
                                    <option value="pulses">Pulses</option>
                                    <option value="vegetables">Vegetables</option>
                                    <option value="fruits">Fruits</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="growth_stage" class="form-label">Growth Stage *</label>
                                <select class="form-select" id="growth_stage" name="growth_stage" required>
                                    <option value="" disabled selected>Select Stage</option>
                                    <option value="sowing">Sowing</option>
                                    <option value="vegetative">Vegetative</option>
                                    <option value="flowering">Flowering</option>
                                    <option value="fruiting">Fruiting</option>
                                    <option value="maturity">Maturity</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mt-4 text-success">Environmental Factors</h5>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="soil_moisture" class="form-label">Soil Moisture</label>
                                <select class="form-select" id="soil_moisture" name="soil_moisture">
                                    <option value="dry">Dry</option>
                                    <option value="normal" selected>Normal</option>
                                    <option value="wet">Wet</option>
                                    <option value="waterlogged">Waterlogged</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="weather_forecast" class="form-label">Weather Forecast</label>
                                <select class="form-select" id="weather_forecast" name="weather_forecast">
                                    <option value="clear">Clear Skies</option>
                                    <option value="partly_cloudy">Partly Cloudy</option>
                                    <option value="cloudy">Cloudy</option>
                                    <option value="rain">Rain Expected</option>
                                    <option value="heavy_rain">Heavy Rain Expected</option>
                                    <option value="drought">Drought Conditions</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="temperature" class="form-label">Temperature (°C) *</label>
                                <input type="number" step="0.1" class="form-control" id="temperature" 
                                       name="temperature" required value="{{ request.form.temperature if request.form.temperature else '28' }}">
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mt-4 text-success">Pest & Disease Observations</h5>
                    <div class="mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="pest_infestation" name="pest_infestation">
                            <label class="form-check-label" for="pest_infestation">Pest Infestation</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="disease_signs" name="disease_signs">
                            <label class="form-check-label" for="disease_signs">Disease Signs</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="weed_problem" name="weed_problem">
                            <label class="form-check-label" for="weed_problem">Weed Problem</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observations" class="form-label">Additional Observations</label>
                        <textarea class="form-control" id="observations" name="observations" rows="3" 
                                  placeholder="Any unusual observations about your crops or weather conditions"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-shield-check"></i> Assess Risks
                        </button>
                    </div>
                </form>
                
                {% if result %}
                <div class="mt-5">
                    <h4 class="text-success">Risk Assessment Results</h4>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Risk Level</h5>
                                    {% if result.risk_level == 'High' %}
                                    <div class="alert alert-danger">
                                        <h2 class="display-4 text-center">
                                            <i class="bi bi-exclamation-triangle-fill"></i> High Risk
                                        </h2>
                                    </div>
                                    {% elif result.risk_level == 'Moderate' %}
                                    <div class="alert alert-warning">
                                        <h2 class="display-4 text-center">
                                            <i class="bi bi-exclamation-triangle"></i> Moderate Risk
                                        </h2>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-success">
                                        <h2 class="display-4 text-center">
                                            <i class="bi bi-check-circle"></i> Low Risk
                                        </h2>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-3">
                                        <h6>Potential Threats:</h6>
                                        <div class="list-group">
                                            {% for threat in result.potential_threats %}
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                {{ threat }}
                                                <span class="badge bg-danger rounded-pill">High</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Preventive Measures</h5>
                                    <ul class="list-group list-group-flush">
                                        {% for measure in result.preventive_measures %}
                                        <li class="list-group-item">
                                            <i class="bi bi-check-circle text-success"></i> {{ measure }}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    
                                    <div class="alert alert-info mt-3">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Next Steps:</strong> {{ result.next_steps }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">7-Day Weather Forecast</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Date</th>
                                            <th>Condition</th>
                                            <th>High</th>
                                            <th>Low</th>
                                            <th>Rain %</th>
                                            <th>Wind (km/h)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for day in result.weather_forecast %}
                                        <tr>
                                            <td>{{ day.date }}</td>
                                            <td>
                                                <i class="bi bi-{{ day.icon }}"></i> {{ day.condition }}
                                            </td>
                                            <td>{{ day.high }}°C</td>
                                            <td>{{ day.low }}°C</td>
                                            <td>{{ day.rain_chance }}%</td>
                                            <td>{{ day.wind_speed }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Quick Tips for Disaster Preparedness</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6><i class="bi bi-cloud-rain text-primary"></i> Flood Preparedness</h6>
                                <ul class="small">
                                    <li>Create proper drainage systems in fields</li>
                                    <li>Store seeds and fertilizers in elevated areas</li>
                                    <li>Have a plan for livestock safety</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6><i class="bi bi-sun text-warning"></i> Drought Management</h6>
                                <ul class="small">
                                    <li>Practice water conservation techniques</li>
                                    <li>Use drought-resistant crop varieties</li>
                                    <li>Implement mulching to retain soil moisture</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="bi bi-bug text-danger"></i> Pest Control</h6>
                                <ul class="small">
                                    <li>Regularly monitor crops for pest activity</li>
                                    <li>Use integrated pest management (IPM) techniques</li>
                                    <li>Maintain field hygiene</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="bi bi-shield-check text-success"></i> General Tips</h6>
                                <ul class="small">
                                    <li>Keep emergency contacts handy</li>
                                    <li>Have an evacuation plan if needed</li>
                                    <li>Stay updated with weather forecasts</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Form validation
(function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms)
        .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
})()

// Set default values based on user's location if available
if (navigator.geolocation) {
    document.getElementById('get-location').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Detecting...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                // In a real app, you would reverse geocode these coordinates to get the location
                document.getElementById('latitude').value = position.coords.latitude.toFixed(4);
                document.getElementById('longitude').value = position.coords.longitude.toFixed(4);
                
                // For demo purposes, we'll just show a success message
                const locationBtn = document.getElementById('get-location');
                locationBtn.classList.remove('btn-outline-secondary');
                locationBtn.classList.add('btn-success');
                locationBtn.innerHTML = '<i class="bi bi-check-circle"></i> Location Detected';
                
                // You would typically call a reverse geocoding API here to get the address
                // For now, we'll just enable the district field for manual entry
                document.getElementById('district').focus();
            },
            function(error) {
                console.error('Error getting location:', error);
                const locationBtn = document.getElementById('get-location');
                locationBtn.classList.remove('btn-outline-secondary');
                locationBtn.classList.add('btn-danger');
                locationBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Location Error';
                
                // Re-enable the button after a delay
                setTimeout(() => {
                    locationBtn.disabled = false;
                    locationBtn.classList.remove('btn-danger');
                    locationBtn.classList.add('btn-outline-secondary');
                    locationBtn.innerHTML = '<i class="bi bi-geo-alt"></i> Use My Location';
                }, 3000);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    });
} else {
    document.getElementById('get-location').disabled = true;
    document.getElementById('get-location').title = 'Geolocation is not supported by your browser';
}
</script>
{% endblock %}
